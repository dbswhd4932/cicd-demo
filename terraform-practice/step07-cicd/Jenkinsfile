// ============================================
// Jenkins Pipeline (EKS ë‚´ Jenkins + CodeCommit)
// ============================================
// Kubernetes Agent Podì—ì„œ ë¹Œë“œ ì‹¤í–‰
// ì´ íŒŒì¼ì„ CodeCommit ì €ì¥ì†Œ ë£¨íŠ¸ì— ìœ„ì¹˜ì‹œí‚¤ì„¸ìš”

pipeline {
    // Kubernetes Agent Pod ì‚¬ìš© (ë™ì  ìƒì„±)
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  serviceAccountName: jenkins
  containers:
    # Docker ë¹Œë“œìš© ì»¨í…Œì´ë„ˆ (DinD)
    - name: docker
      image: docker:24-dind
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
      volumeMounts:
        - name: docker-storage
          mountPath: /var/lib/docker

    # AWS CLI + kubectl ì»¨í…Œì´ë„ˆ
    - name: aws-kubectl
      image: amazon/aws-cli:latest
      command: ["sleep"]
      args: ["infinity"]

  volumes:
    - name: docker-storage
      emptyDir: {}
'''
        }
    }

    environment {
        AWS_REGION     = 'ap-northeast-2'
        ECR_REPOSITORY = 'yoon-app'
        EKS_CLUSTER    = 'yoon-eks'
        IMAGE_TAG      = "${BUILD_NUMBER}"
    }

    stages {
        // ============================================
        // 1ë‹¨ê³„: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        // ============================================
        stage('Checkout') {
            steps {
                checkout scm
                echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"
                sh "ls -la"
            }
        }

        // ============================================
        // 2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        // ============================================
        stage('Build') {
            steps {
                container('docker') {
                    script {
                        echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
                        sh "docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} ."
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                    }
                }
            }
        }

        // ============================================
        // 3ë‹¨ê³„: ECR Push
        // ============================================
        stage('Push to ECR') {
            steps {
                container('docker') {
                    script {
                        echo "ğŸ“¤ ECRì— ì´ë¯¸ì§€ Push..."

                        // apkë¡œ aws-cli ì„¤ì¹˜ (docker ì´ë¯¸ì§€ì—ëŠ” ì—†ìŒ)
                        sh "apk add --no-cache aws-cli"

                        // AWS ê³„ì • ID ê°€ì ¸ì˜¤ê¸°
                        def awsAccountId = sh(
                            script: "aws sts get-caller-identity --query Account --output text",
                            returnStdout: true
                        ).trim()

                        def ecrRegistry = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com"

                        // ECR ë¡œê·¸ì¸
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | \
                            docker login --username AWS --password-stdin ${ecrRegistry}
                        """

                        // íƒœê¹… ë° Push
                        sh """
                            docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ecrRegistry}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ecrRegistry}/${ECR_REPOSITORY}:latest
                            docker push ${ecrRegistry}/${ECR_REPOSITORY}:${IMAGE_TAG}
                            docker push ${ecrRegistry}/${ECR_REPOSITORY}:latest
                        """

                        // ë‹¤ìŒ Stageì—ì„œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜ ì €ì¥
                        env.ECR_REGISTRY = ecrRegistry

                        echo "âœ… ECR Push ì™„ë£Œ: ${ecrRegistry}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                    }
                }
            }
        }

        // ============================================
        // 4ë‹¨ê³„: EKS ë°°í¬
        // ============================================
        stage('Deploy to EKS') {
            steps {
                container('aws-kubectl') {
                    script {
                        echo "ğŸš€ EKSì— ë°°í¬..."

                        // kubectl ì„¤ì¹˜
                        sh """
                            curl -LO "https://dl.k8s.io/release/\$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                            chmod +x kubectl
                            mv kubectl /usr/local/bin/
                        """

                        // kubeconfig ì„¤ì •
                        sh "aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER}"

                        // Deployment ì¡´ì¬ í™•ì¸
                        def exists = sh(
                            script: "kubectl get deployment yoon-app -n default --ignore-not-found | grep yoon-app || true",
                            returnStdout: true
                        ).trim()

                        if (exists) {
                            // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                            sh """
                                kubectl set image deployment/yoon-app \
                                    yoon-app=${env.ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} \
                                    -n default
                            """
                            sh "kubectl rollout status deployment/yoon-app -n default --timeout=300s"
                            echo "âœ… ë°°í¬ ì™„ë£Œ"
                        } else {
                            echo "âš ï¸ Deploymentê°€ ì—†ìŠµë‹ˆë‹¤. Step 08ì—ì„œ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”."
                            echo "ë˜ëŠ”: kubectl create deployment yoon-app --image=${env.ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ! Image: ${ECR_REPOSITORY}:${IMAGE_TAG}"
        }
        failure {
            echo "âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨! Console Outputì„ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}
